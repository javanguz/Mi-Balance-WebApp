<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login | Mi Balance</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode/1.5.1/qrcode.min.js"></script>
    <style>
        body { 
            background-color: #f4f7f9;
            font-family: 'Poppins', sans-serif;
        }
        .login-container { display: flex; align-items: center; justify-content: center; min-height: 100vh; padding: 1rem; }
        .login-card { width: 100%; max-width: 800px; border: none; box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15); border-radius: 0.75rem; overflow: hidden; }
        .form-container { padding: 2.5rem; }
        .qr-container { background-color: #f8f9fa; text-align: center; padding: 2rem; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        #qr-canvas { border: 5px solid white; border-radius: 0.75rem; box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.1); }
        .pin-form-wrapper { max-width: 220px; margin: 0 auto; }
        @media (max-width: 767.98px) { .form-container { padding: 2rem 1.5rem; } .login-card { max-width: 420px; } }
    </style>
</head>
<body>
    <div class="login-container">
        <div class="card login-card">
            <div class="row g-0">
                <div class="col-md-5 qr-container d-none d-md-flex">
                    <h5 class="mb-3">Acceso Móvil</h5>
                    <canvas id="qr-canvas"></canvas>
                    <p class="text-muted mt-3 mb-1">Escanea para abrir en tu celular</p>
                    <p class="fw-bold" id="lan-url"></p>
                </div>
                <div class="col-12 col-md-7">
                    <div class="form-container">
                        <h1 class="card-title text-center mb-4"><i class="fa-solid fa-square-poll-vertical me-2"></i>Mi Balance</h1>
                        <p class="text-center text-muted mb-4">Ingrese su PIN para continuar</p>
                        <% if (error) { %><div class="alert alert-danger" role="alert"><%= error %></div><% } %>
                        <% if (success) { %><div class="alert alert-success" role="alert"><%= success %></div><% } %>
                        <div class="pin-form-wrapper">
                            <form action="/login" method="POST">
                                <div class="mb-3"><input type="password" name="pin" class="form-control form-control-lg text-center" maxlength="4" autofocus required pattern="\d{4}" title="El PIN debe ser de 4 dígitos numéricos."></div>
                                <div class="d-grid"><button type="submit" class="btn btn-primary btn-lg">Ingresar</button></div>
                            </form>
                        </div>

                        <% if (pinHint) { %>
                            <div class="text-center mt-3">
                                <a href="#" id="show-hint-link" style="text-decoration: none; font-size: 0.9rem;">¿Olvidaste tu PIN?</a>
                            </div>
                            <div id="pin-hint-container" class="mt-2" style="display: none; opacity: 0; text-align: center; transition: opacity 0.5s ease;">
                                <div class="alert alert-info py-2">
                                    <strong>Pista:</strong> <%= pinHint %>
                                </div>
                                <a href="#" id="recover-by-license-link" style="text-decoration: none; font-size: 0.9rem;">Restablecer PIN con licencia</a>
                            </div>
                        <% } %>

                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modal-recover-by-license" tabindex="-1" aria-labelledby="modalRecoverLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalRecoverLabel">Restablecer PIN con Licencia</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted small">Ingrese los datos exactos de su licencia para restablecer su PIN.</p>
                    <div id="recover-error" class="alert alert-danger d-none" role="alert"></div>
                    <form id="form-recover-by-license">
                        <div class="mb-3">
                            <label for="recover-username" class="form-label fw-bold">Nombre de Usuario</label>
                            <input type="text" class="form-control" id="recover-username" required>
                        </div>
                        <div class="mb-3">
                            <label for="recover-cuit" class="form-label fw-bold">CUIT</label>
                            <input type="text" class="form-control" id="recover-cuit" required>
                        </div>
                        <div class="mb-3">
                            <label for="recover-key" class="form-label fw-bold">Clave de Licencia</label>
                            <input type="text" class="form-control" id="recover-key" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="btn-submit-recover">Restablecer PIN</button>
                </div>
            </div>
        </div>
    </div>

    <!-- INICIO DE CORRECCIÓN: Se agrega el script de Bootstrap aquí, antes del script personalizado -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- FIN DE CORRECCIÓN -->

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Lógica de QR y código secreto (sin cambios)
            const ip = '<%= ip %>'; const port = '<%= port %>';
            if (ip && ip !== 'localhost' && ip !== '127.0.0.1') {
                const url = `http://${ip}:${port}`;
                const urlDisplay = document.getElementById('lan-url');
                if (urlDisplay) urlDisplay.textContent = url;
                const canvas = document.getElementById('qr-canvas');
                if (canvas) { QRCode.toCanvas(canvas, url, { width: 180, margin: 2, color: { dark: '#000000', light: '#FFFFFF' } }, function (error) { if (error) console.error(error); }); }
            } else {
                const qrContainer = document.querySelector('.qr-container');
                if(qrContainer) { qrContainer.innerHTML = '<p class="text-muted m-auto">El acceso por QR solo está disponible cuando la app se ejecuta en una red local.</p>'; }
            }
            const secretCode = ['a', 'c', 'ArrowUp', 'b', 'ArrowUp', 'b', 'a', 'ArrowDown'];
            let keySequence = [];
            document.addEventListener('keydown', function(e) {
                if (e.target.tagName === 'INPUT') return;
                keySequence.push(e.key);
                if (keySequence.length > secretCode.length) keySequence.shift();
                if (JSON.stringify(keySequence) === JSON.stringify(secretCode)) {
                    window.location.href = '/emergency-recovery';
                    keySequence = [];
                }
            });

            // Lógica para Pista y Modal de Licencia
            const recoverModalEl = document.getElementById('modal-recover-by-license');
            const showHintLink = document.getElementById('show-hint-link');
            const hintContainer = document.getElementById('pin-hint-container');

            if (recoverModalEl && showHintLink && hintContainer) {
                const recoverModal = new bootstrap.Modal(recoverModalEl);

                showHintLink.addEventListener('click', function(e) {
                    e.preventDefault();
                    this.style.display = 'none';
                    hintContainer.style.display = 'block';
                    setTimeout(() => { hintContainer.style.opacity = 1; }, 10);
                });

                const formContainer = document.querySelector('.form-container');
                if (formContainer) {
                    formContainer.addEventListener('click', function(e) {
                        if (e.target.id === 'recover-by-license-link') {
                            e.preventDefault();
                            recoverModal.show();
                        }
                    });
                }
                
                const recoverForm = document.getElementById('form-recover-by-license');
                const submitRecoverBtn = document.getElementById('btn-submit-recover');
                const errorDiv = document.getElementById('recover-error');
                
                submitRecoverBtn.addEventListener('click', async () => {
                    const username = document.getElementById('recover-username').value;
                    const cuit = document.getElementById('recover-cuit').value;
                    const licenseKey = document.getElementById('recover-key').value;
                    errorDiv.classList.add('d-none');
                    if (!username || !cuit || !licenseKey) {
                        errorDiv.textContent = 'Todos los campos son obligatorios.';
                        errorDiv.classList.remove('d-none');
                        return;
                    }
                    try {
                        submitRecoverBtn.disabled = true;
                        submitRecoverBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Verificando...';
                        const response = await fetch('/recover-by-license', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ username, cuit, licenseKey })
                        });
                        const result = await response.json();
                        if (response.ok && result.success) {
                            recoverModal.hide();
                            window.location.href = '/inicio';
                        } else {
                            errorDiv.textContent = result.message || 'Error desconocido.';
                            errorDiv.classList.remove('d-none');
                        }
                    } catch (error) {
                        errorDiv.textContent = 'Error de conexión con el servidor.';
                        errorDiv.classList.remove('d-none');
                    } finally {
                        submitRecoverBtn.disabled = false;
                        submitRecoverBtn.textContent = 'Restablecer PIN';
                    }
                });

                recoverModalEl.addEventListener('hidden.bs.modal', () => {
                    recoverForm.reset();
                    errorDiv.classList.add('d-none');
                    submitRecoverBtn.disabled = false;
                    submitRecoverBtn.textContent = 'Restablecer PIN';
                });
            }
        });
    </script>
</body>
</html>

